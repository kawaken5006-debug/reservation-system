<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å›æ•°åˆ¸ãƒ•ã‚©ãƒ­ãƒ¼ã‚¢ãƒƒãƒ—æ¤œç´¢</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background-color: #f5f5f5;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .loading-spinner {
      animation: spin 1s linear infinite;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    function TicketSearchApp() {
      const [isLoading, setIsLoading] = useState(false); // åˆæœŸçŠ¶æ…‹ã‚’falseã«å¤‰æ›´
      const [allDataByDate, setAllDataByDate] = useState({});
      const [customerDb, setCustomerDb] = useState({});
      const [targetCustomers, setTargetCustomers] = useState([]);
      const [filterConditions, setFilterConditions] = useState({
        maxRemaining: 3,
        remainingEnabled: false, // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆOFF
        periodType: 'within',
        periodDays: 30,
        periodEnabled: false, // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆOFF
        visitedRangeStart: '',
        visitedRangeEnd: '',
        visitedRangeEnabled: false,
        notVisitedRangeStart: '',
        notVisitedRangeEnd: '',
        notVisitedRangeEnabled: false,
        ticketOwnership: 'hasTicket',
        ticketOwnershipEnabled: false, // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆOFF
        reviewFilter: 'all',
        reviewEnabled: false
      });

      // ãƒ‡ãƒ¼ã‚¿ã‚’localStorageã‹ã‚‰èª­ã¿è¾¼ã¿
      useEffect(() => {
        try {
          const storedData = localStorage.getItem('allDataByDate');
          const storedCustomerDb = localStorage.getItem('customerDb');
          
          if (storedData) {
            setAllDataByDate(JSON.parse(storedData));
          }
          if (storedCustomerDb) {
            setCustomerDb(JSON.parse(storedCustomerDb));
          }
        } catch (error) {
          console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
          alert('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      }, []);

      // åˆæœŸçŠ¶æ…‹ã§ã¯ç©ºã®ãƒªã‚¹ãƒˆ
      // useEffectã«ã‚ˆã‚‹è‡ªå‹•ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã¯ç„¡åŠ¹åŒ–ï¼ˆæ¤œç´¢ãƒœã‚¿ãƒ³æŠ¼ä¸‹æ™‚ã®ã¿å®Ÿè¡Œï¼‰

      // æ¤œç´¢ãƒœã‚¿ãƒ³æŠ¼ä¸‹æ™‚ã®ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
      const handleSearch = () => {
        setIsLoading(true);
        
        setTimeout(() => {
          try {
            const results = performFiltering();
            setTargetCustomers(results);
          } catch (error) {
            console.error('ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã‚¨ãƒ©ãƒ¼:', error);
            setTargetCustomers([]);
          } finally {
            setIsLoading(false);
          }
        }, 100);
      };

      const formatDate = (date) => {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`; // YYYY-MM-DDå½¢å¼ã«å¤‰æ›´ï¼ˆallDataByDateã®ã‚­ãƒ¼å½¢å¼ã«åˆã‚ã›ã‚‹ï¼‰
      };

      const performFiltering = () => {
        const {
          maxRemaining, remainingEnabled,
          periodType, periodDays, periodEnabled,
          visitedRangeStart, visitedRangeEnd, visitedRangeEnabled,
          notVisitedRangeStart, notVisitedRangeEnd, notVisitedRangeEnabled,
          ticketOwnership, ticketOwnershipEnabled, reviewFilter, reviewEnabled
        } = filterConditions;

        // åŸºæº–æ—¥ã‚’è¨ˆç®—
        const referenceDate = new Date();
        referenceDate.setDate(referenceDate.getDate() - periodDays);
        const referenceDateStr = formatDate(referenceDate);

        console.log('ğŸ” ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°é–‹å§‹');
        console.log('ğŸ“… åŸºæº–æ—¥:', referenceDateStr, `(ä»Šæ—¥ã‹ã‚‰${periodDays}æ—¥å‰)`);
        console.log('ğŸ“Š å…¨é¡§å®¢æ•°:', Object.keys(customerDb).length);
        console.log('ğŸ“Š äºˆç´„ãƒ‡ãƒ¼ã‚¿ä»¶æ•°:', Object.keys(allDataByDate).length);

        // äºˆç´„ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰é¡§å®¢IDã¨æ¥é™¢æ—¥ã®ãƒãƒƒãƒ—ã‚’ä½œæˆ
        const customerVisitsMap = {};

        Object.entries(allDataByDate).forEach(([date, dateData]) => {
          if (date === 'customer-db' || date === '2025' || date.length === 4) return;
          const data = dateData?.data || {};

          Object.entries(data).forEach(([key, value]) => {
            if (key.endsWith('-id') && value) {
              const customerId = typeof value === 'object' ? value.id : value;
              if (customerId) {
                if (!customerVisitsMap[customerId]) {
                  customerVisitsMap[customerId] = new Set();
                }
                customerVisitsMap[customerId].add(date);
              }
            }
          });
        });

        console.log('ğŸ‘¥ æ¥é™¢ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹é¡§å®¢æ•°:', Object.keys(customerVisitsMap).length);
        if (Object.keys(customerVisitsMap).length > 0) {
          const sampleId = Object.keys(customerVisitsMap)[0];
          const sampleDates = Array.from(customerVisitsMap[sampleId]);
          console.log('ğŸ“‹ ã‚µãƒ³ãƒ—ãƒ«é¡§å®¢ã®æ¥é™¢æ—¥:', sampleId, sampleDates);
        }

        const allCustomerIds = new Set([
          ...Object.keys(customerDb),
          ...Object.keys(customerVisitsMap)
        ]);

        // ã‚·ã‚¹ãƒ†ãƒ æ ã‚’é™¤å¤–ï¼ˆæ•°å­—ã®ã¿ã®IDã‚„ç‰¹å®šã®åå‰ï¼‰
        const excludeSystemIds = (id) => {
          const customer = customerDb[id] || {};
          const name = customer.name || '';
          
          // æ•°å­—ã®ã¿ã®IDï¼ˆ1, 2, 3ãªã©ï¼‰ã‚’é™¤å¤–
          if (/^\d+$/.test(id) && parseInt(id) < 100) {
            return false;
          }
          
          // ã‚·ã‚¹ãƒ†ãƒ ç”¨ã®åå‰ã‚’é™¤å¤–
          const systemNames = ['æ¥½ãƒˆãƒ¬', 'æ–°æ‚£', 'ç¾å®¹', 'æ ', 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«'];
          if (systemNames.some(keyword => name.includes(keyword))) {
            return false;
          }
          
          return true;
        };

        console.log('ğŸ‘¥ ã‚·ã‚¹ãƒ†ãƒ æ é™¤å¤–å‰:', allCustomerIds.size);
        const filteredIds = Array.from(allCustomerIds).filter(excludeSystemIds);
        console.log('ğŸ‘¥ ã‚·ã‚¹ãƒ†ãƒ æ é™¤å¤–å¾Œ:', filteredIds.length);

        // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
        const results = filteredIds
          .filter((id) => {
            const customer = customerDb[id] || {};
            const tickets = Array.isArray(customer.tickets) ? customer.tickets : [];
            const hasTickets = tickets.length > 0;

            // å›æ•°åˆ¸ã®æœ‰ç„¡ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼ˆæœ‰åŠ¹ãªå ´åˆã®ã¿ï¼‰
            if (ticketOwnershipEnabled) {
              if (ticketOwnership === 'hasTicket' && !hasTickets) return false;
              if (ticketOwnership === 'noTicket' && hasTickets) return false;
            }

            // å£ã‚³ãƒŸãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
            if (reviewEnabled && reviewFilter !== 'all') {
              let hasReviewYes = false;
              let hasReviewNo = false;

              Object.entries(allDataByDate).forEach(([date, dateData]) => {
                if (date === 'customer-db' || date === '2025' || date.length === 4) return;
                const data = dateData?.data || {};
                const reviewData = dateData?.reviewData || {};

                Object.entries(data).forEach(([key, value]) => {
                  if (key.endsWith('-id') && value) {
                    const customerId = typeof value === 'object' ? value.id : value;
                    if (customerId === id) {
                      const timeCol = key.replace('-id', '');
                      const reviewKey = timeCol;
                      const review = reviewData[reviewKey];
                      if (review?.status === 'yes') hasReviewYes = true;
                      if (review?.status === 'no') hasReviewNo = true;
                    }
                  }
                });
              });

              if (reviewFilter === 'yes' && !hasReviewYes) return false;
              if (reviewFilter === 'no' && !hasReviewNo && !hasReviewYes) return false;
            }

            const visitDatesSet = customerVisitsMap[id] || new Set();
            const visitDates = Array.from(visitDatesSet).sort();

            // ãƒ‡ãƒãƒƒã‚°: æœ€åˆã®5äººã ã‘ãƒ­ã‚°å‡ºåŠ›
            if (filteredIds.indexOf(id) < 5) {
              console.log(`ğŸ‘¤ é¡§å®¢ ${id} (${customer.name || 'åå‰ãªã—'}):`, {
                hasTickets,
                visitDates,
                lastVisit: visitDates.length > 0 ? visitDates[visitDates.length - 1] : 'ãªã—',
                referenceDateStr
              });
            }

            // ã™ã¹ã¦ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãŒç„¡åŠ¹ã®å ´åˆã¯å…¨é¡§å®¢ã‚’è¡¨ç¤º
            if (!remainingEnabled && !periodEnabled && !visitedRangeEnabled && !notVisitedRangeEnabled) {
              return true;
            }

            // å›æ•°åˆ¸ãŒãªã„å ´åˆã¯äºˆç´„ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰åˆ¤å®š
            if (!hasTickets) {
              if (visitDates.length === 0) {
                if (periodEnabled || visitedRangeEnabled || notVisitedRangeEnabled) return false;
                return true;
              }

              const lastVisit = visitDates[visitDates.length - 1];

              // æ—¥æ•°ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
              if (periodEnabled) {
                if (periodType === 'within') {
                  if (lastVisit < referenceDateStr) return false;
                } else {
                  if (lastVisit >= referenceDateStr) return false;
                }
              }

              // æ¥é™¢ã—ãŸæœŸé–“ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
              if (visitedRangeEnabled && visitedRangeStart && visitedRangeEnd) {
                const hasVisitInRange = visitDates.some(v => v >= visitedRangeStart && v <= visitedRangeEnd);
                if (!hasVisitInRange) return false;
              }

              // æ¥é™¢ã—ã¦ã„ãªã„æœŸé–“ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
              if (notVisitedRangeEnabled && notVisitedRangeStart && notVisitedRangeEnd) {
                const hasVisitInRange = visitDates.some(v => v >= notVisitedRangeStart && v <= notVisitedRangeEnd);
                if (hasVisitInRange) return false;
              }

              return true;
            }

            // å›æ•°åˆ¸æŒã¡ã®å ´åˆ
            return tickets.some(ticket => {
              const used = ticket.used || [];
              const remaining = ticket.count - used.length;

              if (remainingEnabled) {
                if (remaining > maxRemaining) return false;
              }

              if (!periodEnabled && !visitedRangeEnabled && !notVisitedRangeEnabled) {
                return true;
              }

              if (visitDates.length === 0) {
                return false;
              }

              const lastVisit = visitDates[visitDates.length - 1];

              if (periodEnabled) {
                if (periodType === 'within') {
                  if (lastVisit < referenceDateStr) return false;
                } else {
                  if (lastVisit >= referenceDateStr) return false;
                }
              }

              if (visitedRangeEnabled && visitedRangeStart && visitedRangeEnd) {
                const hasVisitInRange = visitDates.some(v => v >= visitedRangeStart && v <= visitedRangeEnd);
                if (!hasVisitInRange) return false;
              }

              if (notVisitedRangeEnabled && notVisitedRangeStart && notVisitedRangeEnd) {
                const hasVisitInRange = visitDates.some(v => v >= notVisitedRangeStart && v <= notVisitedRangeEnd);
                if (hasVisitInRange) return false;
              }

              return true;
            });
          })
          .map((id) => {
            const customer = customerDb[id] || {};
            const tickets = Array.isArray(customer.tickets) ? customer.tickets : [];
            const visitDatesSet = customerVisitsMap[id] || new Set();
            const visitDates = Array.from(visitDatesSet).sort();

            // å£ã‚³ãƒŸæƒ…å ±ã‚’å–å¾—
            let hasReviewYes = false;
            let hasReviewNo = false;
            Object.entries(allDataByDate).forEach(([date, dateData]) => {
              if (date === 'customer-db' || date === '2025' || date.length === 4) return;
              const data = dateData?.data || {};
              const reviewData = dateData?.reviewData || {};

              Object.entries(data).forEach(([key, value]) => {
                if (key.endsWith('-id') && value) {
                  const cid = typeof value === 'object' ? value.id : value;
                  if (cid === id) {
                    const timeCol = key.replace('-id', '');
                    const review = reviewData[timeCol];
                    if (review?.status === 'yes') hasReviewYes = true;
                    if (review?.status === 'no') hasReviewNo = true;
                  }
                }
              });
            });

            const reviewStatus = hasReviewYes ? 'â—‹' : (hasReviewNo ? 'Ã—' : '-');

            if (tickets.length === 0) {
              return {
                id,
                name: customer.name || id,
                furigana: customer.furigana || '',
                staff: customer.staff || '',
                review: reviewStatus,
                tickets: [{
                  ticketName: 'å›æ•°åˆ¸ãªã—',
                  ticketNumber: '-',
                  remaining: '-',
                  lastUsed: visitDates.length > 0 ? visitDates[visitDates.length - 1] : 'æ¥é™¢ãªã—'
                }]
              };
            }

            const validTickets = tickets
              .map((ticket, idx) => {
                const used = ticket.used || [];
                const remaining = ticket.count - used.length;

                if (remainingEnabled && remaining > maxRemaining) return null;

                if (!periodEnabled && !visitedRangeEnabled && !notVisitedRangeEnabled) {
                  const lastVisit = visitDates.length > 0 ? visitDates[visitDates.length - 1] : 'æ¥é™¢ãªã—';
                  return {
                    ticketName: `${ticket.name} ${ticket.count}å›`,
                    ticketNumber: idx + 1,
                    remaining,
                    lastUsed: lastVisit
                  };
                }

                if (visitDates.length === 0) return null;

                const lastVisit = visitDates[visitDates.length - 1];

                if (periodEnabled) {
                  const meetsDateCondition = periodType === 'within'
                    ? lastVisit >= referenceDateStr
                    : lastVisit < referenceDateStr;
                  if (!meetsDateCondition) return null;
                }

                if (visitedRangeEnabled && visitedRangeStart && visitedRangeEnd) {
                  const hasVisitInRange = visitDates.some(v => v >= visitedRangeStart && v <= visitedRangeEnd);
                  if (!hasVisitInRange) return null;
                }

                if (notVisitedRangeEnabled && notVisitedRangeStart && notVisitedRangeEnd) {
                  const hasVisitInRange = visitDates.some(v => v >= notVisitedRangeStart && v <= notVisitedRangeEnd);
                  if (hasVisitInRange) return null;
                }

                return {
                  ticketName: `${ticket.name} ${ticket.count}å›`,
                  ticketNumber: idx + 1,
                  remaining,
                  lastUsed: lastVisit
                };
              })
              .filter(t => t !== null);

            if (validTickets.length === 0) return null;

            return {
              id,
              name: customer.name || id,
              furigana: customer.furigana || '',
              staff: customer.staff || '',
              review: reviewStatus,
              tickets: validTickets
            };
          })
          .filter(c => c !== null);

        console.log('âœ… ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å®Œäº†: ', results.length, 'ä»¶');
        
        return results;
      };

      const exportCSV = () => {
        const rows = [
          ['ID', 'åå‰', 'ãµã‚ŠãŒãª', 'æ‹…å½“', 'å£ã‚³ãƒŸ', 'å›æ•°åˆ¸ç¨®é¡', 'å›æ•°åˆ¸ç•ªå·', 'æ®‹ã‚Šå›æ•°', 'æœ€çµ‚ä½¿ç”¨æ—¥']
        ];

        targetCustomers.forEach(customer => {
          customer.tickets.forEach(ticket => {
            rows.push([
              customer.id,
              customer.name,
              customer.furigana,
              customer.staff,
              customer.review,
              ticket.ticketName,
              ticket.ticketNumber,
              ticket.remaining,
              ticket.lastUsed
            ]);
          });
        });

        const csvContent = rows.map(row => row.join(',')).join('\n');
        const bom = '\uFEFF';
        const blob = new Blob([bom + csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `å›æ•°åˆ¸ãƒ•ã‚©ãƒ­ãƒ¼ã‚¢ãƒƒãƒ—ãƒªã‚¹ãƒˆ_${formatDate(new Date())}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      };

      return (
        <div style={{ maxWidth: '100%', margin: 0, padding: 0 }}>
          {/* ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¡ä»¶ - æ¥µé™ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆ */}
          <div style={{
            backgroundColor: 'white',
            padding: '8px',
            borderRadius: '0',
            marginBottom: '0',
            boxShadow: 'none',
            border: '1px solid #e0e0e0'
          }}>
            <div style={{ fontSize: '12px', fontWeight: 'bold', marginBottom: '8px', color: '#333', borderBottom: '1px solid #f0f0f0', paddingBottom: '4px' }}>
              æ¤œç´¢æ¡ä»¶
            </div>

            {/* 2ã‚«ãƒ©ãƒ ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */}
            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '10px' }}>
              
              {/* å·¦ã‚«ãƒ©ãƒ  */}
              <div>
                {/* å›æ•°åˆ¸ã®æœ‰ç„¡ */}
                <div style={{ marginBottom: '8px' }}>
                  <label style={{ display: 'flex', alignItems: 'center', gap: '4px', marginBottom: '4px' }}>
                    <input
                      type="checkbox"
                      checked={filterConditions.ticketOwnershipEnabled}
                      onChange={(e) => setFilterConditions(prev => ({ ...prev, ticketOwnershipEnabled: e.target.checked }))}
                      style={{ cursor: 'pointer' }}
                    />
                    <span style={{ fontSize: '13px', fontWeight: '600', color: filterConditions.ticketOwnershipEnabled ? '#333' : '#999' }}>
                      å›æ•°åˆ¸
                    </span>
                  </label>
                  <div style={{ marginLeft: '22px', display: 'flex', gap: '8px', flexWrap: 'wrap' }}>
                    <label style={{ display: 'flex', alignItems: 'center', gap: '3px' }}>
                      <input
                        type="radio"
                        name="ticketOwnership"
                        value="all"
                        checked={filterConditions.ticketOwnership === 'all'}
                        onChange={(e) => setFilterConditions(prev => ({ ...prev, ticketOwnership: e.target.value }))}
                        disabled={!filterConditions.ticketOwnershipEnabled}
                        style={{ cursor: filterConditions.ticketOwnershipEnabled ? 'pointer' : 'not-allowed' }}
                      />
                      <span style={{ fontSize: '12px', color: filterConditions.ticketOwnershipEnabled ? '#333' : '#bbb' }}>å…¨å“¡</span>
                    </label>
                    <label style={{ display: 'flex', alignItems: 'center', gap: '3px' }}>
                      <input
                        type="radio"
                        name="ticketOwnership"
                        value="hasTicket"
                        checked={filterConditions.ticketOwnership === 'hasTicket'}
                        onChange={(e) => setFilterConditions(prev => ({ ...prev, ticketOwnership: e.target.value }))}
                        disabled={!filterConditions.ticketOwnershipEnabled}
                        style={{ cursor: filterConditions.ticketOwnershipEnabled ? 'pointer' : 'not-allowed' }}
                      />
                      <span style={{ fontSize: '12px', color: filterConditions.ticketOwnershipEnabled ? '#333' : '#bbb' }}>ã‚ã‚Š</span>
                    </label>
                    <label style={{ display: 'flex', alignItems: 'center', gap: '3px' }}>
                      <input
                        type="radio"
                        name="ticketOwnership"
                        value="noTicket"
                        checked={filterConditions.ticketOwnership === 'noTicket'}
                        onChange={(e) => setFilterConditions(prev => ({ ...prev, ticketOwnership: e.target.value }))}
                        disabled={!filterConditions.ticketOwnershipEnabled}
                        style={{ cursor: filterConditions.ticketOwnershipEnabled ? 'pointer' : 'not-allowed' }}
                      />
                      <span style={{ fontSize: '12px', color: filterConditions.ticketOwnershipEnabled ? '#333' : '#bbb' }}>ãªã—</span>
                    </label>
                  </div>
                </div>

                {/* æ®‹ã‚Šå›æ•° */}
                <div style={{ marginBottom: '8px' }}>
                  <label style={{ display: 'flex', alignItems: 'center', gap: '4px', marginBottom: '3px' }}>
                    <input
                      type="checkbox"
                      checked={filterConditions.remainingEnabled}
                      onChange={(e) => setFilterConditions(prev => ({ ...prev, remainingEnabled: e.target.checked }))}
                      style={{ cursor: 'pointer' }}
                    />
                    <span style={{ fontSize: '13px', fontWeight: '600', color: filterConditions.remainingEnabled ? '#333' : '#999' }}>
                      æ®‹ã‚Šå›æ•°
                    </span>
                  </label>
                  <div style={{ marginLeft: '22px', display: 'flex', alignItems: 'center', gap: '4px' }}>
                    <input
                      type="number"
                      min="1"
                      max="50"
                      value={filterConditions.maxRemaining}
                      onChange={(e) => setFilterConditions(prev => ({ ...prev, maxRemaining: parseInt(e.target.value) || 3 }))}
                      disabled={!filterConditions.remainingEnabled}
                      style={{
                        width: '50px',
                        padding: '3px 6px',
                        border: '1px solid #ddd',
                        borderRadius: '3px',
                        fontSize: '12px',
                        backgroundColor: filterConditions.remainingEnabled ? 'white' : '#f5f5f5'
                      }}
                    />
                    <span style={{ fontSize: '12px', color: filterConditions.remainingEnabled ? '#333' : '#999' }}>å›ä»¥ä¸‹</span>
                  </div>
                </div>

                {/* å£ã‚³ãƒŸ */}
                <div style={{ marginBottom: '8px' }}>
                  <label style={{ display: 'flex', alignItems: 'center', gap: '4px', marginBottom: '3px' }}>
                    <input
                      type="checkbox"
                      checked={filterConditions.reviewEnabled}
                      onChange={(e) => setFilterConditions(prev => ({ ...prev, reviewEnabled: e.target.checked }))}
                      style={{ cursor: 'pointer' }}
                    />
                    <span style={{ fontSize: '13px', fontWeight: '600', color: filterConditions.reviewEnabled ? '#333' : '#999' }}>
                      å£ã‚³ãƒŸ
                    </span>
                  </label>
                  <div style={{ marginLeft: '22px', display: 'flex', gap: '8px', flexWrap: 'wrap' }}>
                    <label style={{ display: 'flex', alignItems: 'center', gap: '3px' }}>
                      <input
                        type="radio"
                        name="reviewFilter"
                        value="all"
                        checked={filterConditions.reviewFilter === 'all'}
                        onChange={(e) => setFilterConditions(prev => ({ ...prev, reviewFilter: e.target.value }))}
                        disabled={!filterConditions.reviewEnabled}
                        style={{ cursor: filterConditions.reviewEnabled ? 'pointer' : 'not-allowed' }}
                      />
                      <span style={{ fontSize: '12px', color: filterConditions.reviewEnabled ? '#333' : '#bbb' }}>ã™ã¹ã¦</span>
                    </label>
                    <label style={{ display: 'flex', alignItems: 'center', gap: '3px' }}>
                      <input
                        type="radio"
                        name="reviewFilter"
                        value="yes"
                        checked={filterConditions.reviewFilter === 'yes'}
                        onChange={(e) => setFilterConditions(prev => ({ ...prev, reviewFilter: e.target.value }))}
                        disabled={!filterConditions.reviewEnabled}
                        style={{ cursor: filterConditions.reviewEnabled ? 'pointer' : 'not-allowed' }}
                      />
                      <span style={{ fontSize: '12px', color: filterConditions.reviewEnabled ? '#333' : '#bbb' }}>â—‹ã®ã¿</span>
                    </label>
                    <label style={{ display: 'flex', alignItems: 'center', gap: '3px' }}>
                      <input
                        type="radio"
                        name="reviewFilter"
                        value="no"
                        checked={filterConditions.reviewFilter === 'no'}
                        onChange={(e) => setFilterConditions(prev => ({ ...prev, reviewFilter: e.target.value }))}
                        disabled={!filterConditions.reviewEnabled}
                        style={{ cursor: filterConditions.reviewEnabled ? 'pointer' : 'not-allowed' }}
                      />
                      <span style={{ fontSize: '12px', color: filterConditions.reviewEnabled ? '#333' : '#bbb' }}>Ã—ã®ã¿</span>
                    </label>
                  </div>
                </div>
              </div>

              {/* å³ã‚«ãƒ©ãƒ  */}
              <div>
                {/* æ—¥æ•°ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ */}
                <div style={{ marginBottom: '8px' }}>
                  <label style={{ display: 'flex', alignItems: 'center', gap: '4px', marginBottom: '3px' }}>
                    <input
                      type="checkbox"
                      checked={filterConditions.periodEnabled}
                      onChange={(e) => setFilterConditions(prev => ({ ...prev, periodEnabled: e.target.checked }))}
                      style={{ cursor: 'pointer' }}
                    />
                    <span style={{ fontSize: '13px', fontWeight: '600', color: filterConditions.periodEnabled ? '#333' : '#999' }}>
                      æ—¥æ•°
                    </span>
                  </label>
                  <div style={{ marginLeft: '22px', display: 'flex', alignItems: 'center', gap: '4px', flexWrap: 'wrap' }}>
                    <input
                      type="number"
                      min="1"
                      max="365"
                      value={filterConditions.periodDays}
                      onChange={(e) => setFilterConditions(prev => ({ ...prev, periodDays: parseInt(e.target.value) || 30 }))}
                      disabled={!filterConditions.periodEnabled}
                      style={{
                        width: '50px',
                        padding: '3px 6px',
                        border: '1px solid #ddd',
                        borderRadius: '3px',
                        fontSize: '12px',
                        backgroundColor: filterConditions.periodEnabled ? 'white' : '#f5f5f5'
                      }}
                    />
                    <span style={{ fontSize: '12px', color: filterConditions.periodEnabled ? '#333' : '#999' }}>æ—¥</span>
                    <select
                      value={filterConditions.periodType}
                      onChange={(e) => setFilterConditions(prev => ({ ...prev, periodType: e.target.value }))}
                      disabled={!filterConditions.periodEnabled}
                      style={{
                        padding: '3px 6px',
                        border: '1px solid #ddd',
                        borderRadius: '3px',
                        fontSize: '12px',
                        backgroundColor: filterConditions.periodEnabled ? 'white' : '#f5f5f5'
                      }}
                    >
                      <option value="within">ä»¥å†…ã«æ¥é™¢</option>
                      <option value="outside">ä»¥ä¸Šæ¥é™¢ãªã—</option>
                    </select>
                  </div>
                </div>

                {/* æ¥é™¢æœŸé–“ */}
                <div style={{ marginBottom: '8px' }}>
                  <label style={{ display: 'flex', alignItems: 'center', gap: '4px', marginBottom: '3px' }}>
                    <input
                      type="checkbox"
                      checked={filterConditions.visitedRangeEnabled}
                      onChange={(e) => setFilterConditions(prev => ({ ...prev, visitedRangeEnabled: e.target.checked }))}
                      style={{ cursor: 'pointer' }}
                    />
                    <span style={{ fontSize: '13px', fontWeight: '600', color: filterConditions.visitedRangeEnabled ? '#333' : '#999' }}>
                      æ¥é™¢æœŸé–“
                    </span>
                  </label>
                  <div style={{ marginLeft: '22px', display: 'flex', alignItems: 'center', gap: '4px', fontSize: '12px' }}>
                    <input
                      type="date"
                      value={filterConditions.visitedRangeStart}
                      onChange={(e) => setFilterConditions(prev => ({ ...prev, visitedRangeStart: e.target.value }))}
                      disabled={!filterConditions.visitedRangeEnabled}
                      style={{
                        padding: '2px 4px',
                        border: '1px solid #ddd',
                        borderRadius: '3px',
                        fontSize: '11px',
                        backgroundColor: filterConditions.visitedRangeEnabled ? 'white' : '#f5f5f5'
                      }}
                    />
                    <span style={{ color: filterConditions.visitedRangeEnabled ? '#333' : '#999' }}>ã€œ</span>
                    <input
                      type="date"
                      value={filterConditions.visitedRangeEnd}
                      onChange={(e) => setFilterConditions(prev => ({ ...prev, visitedRangeEnd: e.target.value }))}
                      disabled={!filterConditions.visitedRangeEnabled}
                      style={{
                        padding: '2px 4px',
                        border: '1px solid #ddd',
                        borderRadius: '3px',
                        fontSize: '11px',
                        backgroundColor: filterConditions.visitedRangeEnabled ? 'white' : '#f5f5f5'
                      }}
                    />
                  </div>
                </div>

                {/* æœªæ¥é™¢æœŸé–“ */}
                <div style={{ marginBottom: '8px' }}>
                  <label style={{ display: 'flex', alignItems: 'center', gap: '4px', marginBottom: '3px' }}>
                    <input
                      type="checkbox"
                      checked={filterConditions.notVisitedRangeEnabled}
                      onChange={(e) => setFilterConditions(prev => ({ ...prev, notVisitedRangeEnabled: e.target.checked }))}
                      style={{ cursor: 'pointer' }}
                    />
                    <span style={{ fontSize: '13px', fontWeight: '600', color: filterConditions.notVisitedRangeEnabled ? '#333' : '#999' }}>
                      æœªæ¥é™¢æœŸé–“
                    </span>
                  </label>
                  <div style={{ marginLeft: '22px', display: 'flex', alignItems: 'center', gap: '4px', fontSize: '12px' }}>
                    <input
                      type="date"
                      value={filterConditions.notVisitedRangeStart}
                      onChange={(e) => setFilterConditions(prev => ({ ...prev, notVisitedRangeStart: e.target.value }))}
                      disabled={!filterConditions.notVisitedRangeEnabled}
                      style={{
                        padding: '2px 4px',
                        border: '1px solid #ddd',
                        borderRadius: '3px',
                        fontSize: '11px',
                        backgroundColor: filterConditions.notVisitedRangeEnabled ? 'white' : '#f5f5f5'
                      }}
                    />
                    <span style={{ color: filterConditions.notVisitedRangeEnabled ? '#333' : '#999' }}>ã€œ</span>
                    <input
                      type="date"
                      value={filterConditions.notVisitedRangeEnd}
                      onChange={(e) => setFilterConditions(prev => ({ ...prev, notVisitedRangeEnd: e.target.value }))}
                      disabled={!filterConditions.notVisitedRangeEnabled}
                      style={{
                        padding: '2px 4px',
                        border: '1px solid #ddd',
                        borderRadius: '3px',
                        fontSize: '11px',
                        backgroundColor: filterConditions.notVisitedRangeEnabled ? 'white' : '#f5f5f5'
                      }}
                    />
                  </div>
                </div>
              </div>
            </div>

            {/* æ¤œç´¢ãƒœã‚¿ãƒ³ - æ¥µé™ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆ */}
            <button
              onClick={handleSearch}
              disabled={isLoading}
              style={{
                width: '100%',
                padding: '6px',
                backgroundColor: isLoading ? '#9E9E9E' : '#2196F3',
                color: 'white',
                border: 'none',
                borderRadius: '3px',
                fontSize: '13px',
                fontWeight: 'bold',
                cursor: isLoading ? 'not-allowed' : 'pointer',
                marginTop: '6px'
              }}
            >
              {isLoading ? 'æ¤œç´¢ä¸­...' : 'æ¤œç´¢'}
            </button>
          </div>

          {/* æ¤œç´¢çµæœ */}
          <div style={{
            backgroundColor: 'white',
            padding: '6px',
            borderRadius: '0',
            boxShadow: 'none',
            border: '1px solid #e0e0e0',
            borderTop: 'none'
          }}>
            <div style={{
              display: 'flex',
              justifyContent: 'space-between',
              alignItems: 'center',
              marginBottom: '0',
              paddingBottom: '2px',
              borderBottom: '1px solid #f0f0f0'
            }}>
              {isLoading ? (
                <div style={{
                  textAlign: 'center',
                  padding: '10px',
                  width: '100%',
                  fontSize: '12px',
                  color: '#666'
                }}>
                  <div className="loading-spinner" style={{
                    display: 'inline-block',
                    fontSize: '18px'
                  }}>
                    â³
                  </div>
                  <div style={{ marginTop: '6px' }}>æ¤œç´¢ä¸­...</div>
                </div>
              ) : (
                <>
                  <div style={{ fontSize: '12px', color: '#333', fontWeight: '600' }}>
                    å…¨{targetCustomers.length}ä»¶
                  </div>
                  <button
                    onClick={exportCSV}
                    disabled={targetCustomers.length === 0}
                    style={{
                      padding: '3px 8px',
                      backgroundColor: targetCustomers.length === 0 ? '#ccc' : '#4CAF50',
                      color: 'white',
                      border: 'none',
                      borderRadius: '2px',
                      fontSize: '11px',
                      fontWeight: 'bold',
                      cursor: targetCustomers.length === 0 ? 'not-allowed' : 'pointer'
                    }}
                  >
                    CSVå‡ºåŠ›
                  </button>
                </>
              )}
            </div>

            {!isLoading && targetCustomers.length > 0 && (
              <div style={{ maxHeight: '600px', overflowY: 'auto', overflowX: 'auto', marginTop: '0' }}>
                <table style={{
                  width: '100%',
                  borderCollapse: 'collapse',
                  fontSize: '12px',
                  lineHeight: '1.2'
                }}>
                  <thead>
                    <tr style={{ backgroundColor: '#FF9800', color: 'white', position: 'sticky', top: 0 }}>
                      <th style={{ padding: '2px 4px', border: '1px solid #ddd', fontWeight: '600', whiteSpace: 'nowrap', fontSize: '11px' }}>ID</th>
                      <th style={{ padding: '2px 4px', border: '1px solid #ddd', fontWeight: '600', whiteSpace: 'nowrap', fontSize: '11px' }}>åå‰</th>
                      <th style={{ padding: '2px 4px', border: '1px solid #ddd', fontWeight: '600', whiteSpace: 'nowrap', fontSize: '11px' }}>ãµã‚ŠãŒãª</th>
                      <th style={{ padding: '2px 4px', border: '1px solid #ddd', fontWeight: '600', whiteSpace: 'nowrap', fontSize: '11px' }}>æ‹…å½“</th>
                      <th style={{ padding: '2px 4px', border: '1px solid #ddd', fontWeight: '600', whiteSpace: 'nowrap', fontSize: '11px' }}>å£ã‚³ãƒŸ</th>
                      <th style={{ padding: '2px 4px', border: '1px solid #ddd', fontWeight: '600', whiteSpace: 'nowrap', fontSize: '11px' }}>å›æ•°åˆ¸</th>
                      <th style={{ padding: '2px 4px', border: '1px solid #ddd', fontWeight: '600', whiteSpace: 'nowrap', fontSize: '11px' }}>æ®‹ã‚Š</th>
                      <th style={{ padding: '2px 4px', border: '1px solid #ddd', fontWeight: '600', whiteSpace: 'nowrap', fontSize: '11px' }}>æœ€çµ‚ä½¿ç”¨æ—¥</th>
                    </tr>
                  </thead>
                  <tbody>
                    {targetCustomers.map((customer, idx) => (
                      customer.tickets.map((ticket, ticketIdx) => (
                        <tr key={`${idx}-${ticketIdx}`} style={{
                          backgroundColor: idx % 2 === 0 ? '#ffffff' : '#fafafa'
                        }}>
                          {ticketIdx === 0 && (
                            <>
                              <td rowSpan={customer.tickets.length} style={{ padding: '2px 4px', border: '1px solid #ddd', textAlign: 'center', lineHeight: '1.2' }}>
                                {customer.id}
                              </td>
                              <td rowSpan={customer.tickets.length} style={{ padding: '2px 4px', border: '1px solid #ddd', lineHeight: '1.2' }}>
                                {customer.name}
                              </td>
                              <td rowSpan={customer.tickets.length} style={{ padding: '2px 4px', border: '1px solid #ddd', fontSize: '11px', color: '#666', lineHeight: '1.2' }}>
                                {customer.furigana}
                              </td>
                              <td rowSpan={customer.tickets.length} style={{ padding: '2px 4px', border: '1px solid #ddd', textAlign: 'center', lineHeight: '1.2' }}>
                                {customer.staff}
                              </td>
                              <td rowSpan={customer.tickets.length} style={{ padding: '2px 4px', border: '1px solid #ddd', textAlign: 'center', lineHeight: '1.2', fontWeight: 'bold', color: customer.review === 'â—‹' ? '#4CAF50' : customer.review === 'Ã—' ? '#f44336' : '#999' }}>
                                {customer.review}
                              </td>
                            </>
                          )}
                          <td style={{ padding: '2px 4px', border: '1px solid #ddd' }}>{ticket.ticketName}</td>
                          <td style={{ padding: '2px 4px', border: '1px solid #ddd', textAlign: 'center' }}>
                            {ticket.remaining}
                          </td>
                          <td style={{ padding: '2px 4px', border: '1px solid #ddd', textAlign: 'center', fontSize: '11px' }}>
                            {ticket.lastUsed}
                          </td>
                        </tr>
                      ))
                    ))}
                  </tbody>
                </table>
              </div>
            )}

            {!isLoading && targetCustomers.length === 0 && (
              <div style={{
                textAlign: 'center',
                padding: '40px',
                color: '#999',
                fontSize: '16px'
              }}>
                è©²å½“ã™ã‚‹é¡§å®¢ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ
              </div>
            )}
          </div>
        </div>
      );
    }

    ReactDOM.render(<TicketSearchApp />, document.getElementById('root'));
  </script>
</body>
</html>